# NAPI的nodejs版sdk

--------

## 用法

1. npm安装

  ```bash
  npm install http://git.ucweb.local/navi/napi-node-sdk/repository/archive --save
  ```
  
  或者在 ``package.json`` 中声明依赖，并安装
  
  ```json
  {
      ...
      "dependencies": {
          "napi": "http://git.ucweb.local/navi/napi-node-sdk/repository/archive"
      }
      ...
  }
  ```

1. nodejs中使用

  ```javascript
  // 引用模块
  var NAPI = require('napi');
  
  // 创建一个api对象，参数为appID
  var napi = NAPI('c14054a702a3433385f185ef7f1e566e');
  napi.object('news') // 创建一个 news 类的实例
      .get('995d6e996b6044e7bc15b4f08eb42999') // 获取对象
      .done(function(data){ // promise.done(resolve, reject)
          console.log('done', data);
      }, function(err){
          console.log('error', err);
      });
  
  ```

## Examples
[Napi Javascript SDK Example](http://git.ucweb.local/guanks/napi-js-sdk-example)

-----

## NAPI 构造方法

### NAPI(appID [, host, options])

* 源码：[index.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/index.js)
* 说明：创建一个 napi 实例
* 参数：
  * appID ``String`` 应用 id，比如 ``'c14054a702a3433385f185ef7f1e566e'``
  * host ``String`` napi 域名，默认是 ``'http://napi.uc.cn'``
  * options ``Object`` NAPI构造方法的选项, 选项字段：
                - versions `Object` 具体接口的版本配置，目前支持的接口包括：cbject/comment。取值为 '2' 或 '3'
* 返回：`napi 实例`
* 示例：
  
    ```javascript
    var NAPI = require('napi');
    var napi = NAPI('c14054a702a3433385f185ef7f1e566e', 'http://napi.dev.uc.cn');
    var napi = NAPI('c14054a702a3433385f185ef7f1e566e', null, {
          versions: {
            comment: '3' // 评论接口使用第3版
          }
      });
    ```

------

## NAPI 实例接口

### .all( promise[, promise]... )

* 源码：[index.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/index.js)
* 说明：对Promise.all的包装，具体用法请参考 [这里](https://github.com/then/promise#promiseallarray)
* 参数：
  * 数组或独立的参数
* 返回：``Promise``
* 示例：

    ```javascript
    var NAPI = require('napi');
    var napi = NAPI('c14054a702a3433385f185ef7f1e566e')
    napi.all(
      api.object('user').get('2db850abf46a4c75b4a37f47fc8cc419'),
      api.object('news').get('c14054a702a3433385f185ef7f1e566e')
    )
    .done(function(data){
      console.log('done', data);
    });
    ```

### .object(classID)
* 源码: [lib/object.v3.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/object.v3.js)
* 说明：创建一个 **object** `接口实例` 对象
* 参数：
  * classID ``String`` 类 id，比如 ``game``
* 返回：`object 接口`对象

### .comment(category)
* 源码: [lib/comment.v2.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/comment.v2.js)
* 说明：创建一个 **comment** `接口实例` 对象
* 参数：
  * category ``String``评论对象所在的类 id，比如 ``game``
* 返回：`comment 接口`对象

### .base( )
* 源码: [lib/base.api.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.api.js)
* 说明：创建一个 **基础** `接口实例` 对象
* 参数：
  * 空
* 返回：`基础 接口`对象

-------

## object 接口方法

> SDK 的对象接口使用 v3 版本 napi 接口，`RESTfull 接口`参考文档: http://doc.ucweb.local/pages/viewpage.action?pageId=33456430#id-1.NAPI文档v3(Alpha)-对象

### .get(objectID)

* 源码：[lib/object.v3.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/object.v3.js)
* 说明：获取对象
* 参数：
  * objectID ``String``
* 返回：``Promise``
* 示例：
  
  ```javascript
  napi.object('user')
      .get('f190dcb3ed3343379da5e8305edf943e')
      .done(function(data){
          console.log('done', data);
      });
  ```

### .list([categoryID, ] listID)

* 源码：[lib/object.v3.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/object.v3.js)
* 说明：获取 全部/列表/二级列表 下的对象，当参数为空时获取全部数据
* 参数：
  * categoryID `String` 
  * listID ``String``
* 返回：``Promise``
* 示例：

  ```javascript
  napi.object('news')
      .params({ _fetch: 1 })
      .list('sub')
      .done(function(data){
          console.log('done', data);
      });
  ```

### .post([catetory, ] listID )

* 源码：[lib/object.v3.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/object.v3.js)
* 说明：创建一个对象数据, 或者创建并添加到列表/二级列表下
* 参数：
  * catetory ``String`` 列表目录，可选
  * listID ``String`` 列表，可选
* 返回：``Promise``
* 示例：

    ```javascript
    napi.object('news')
        .body({
            'name': 'switer',
            'content': Math.random()
        })
        .post()
        .done(function(data) {})
    ```

### .create([objectId] \[, [catetory, ] listID])

* 源码：[lib/object.v3.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/object.v3.js)
* 说明：创建一个对象数据, 或者创建并添加到列表/二级列表下，可以使用自定义的objectId
* 参数：
  * objectId ``String`` 自定义对象ID，可选
  * catetory ``String`` 列表目录，可选
  * listID ``String`` 列表，可选
* 返回：``Promise``
* 示例：

    ```javascript
    napi.object('news')
        .body({
            'name': 'switer',
            'content': Math.random()
        })
        .create('12345')
        .done(function(data) {})
    ```


### .put(objectID)

* 源码：[lib/object.v3.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/object.v3.js)
* 说明：全量更新对象内容
* 参数：
  * objectID ``String``
  * body ``Object``
* 返回：``Promise``
* 示例：

    ```javascript
    napi.object('news')
        .body({ name: 'myname' })
        .put('995d6e996b6044e7bc15b4f08eb42999')
        .done(function(data){})
    ```

### .patch(objectID)

* 源码：[lib/object.v3.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/object.v3.js)
* 说明：增量更新对象内容
* 参数：
  * objectID ``String``
  * body ``Object``
* 返回：``Promise``
* 示例：

    ```javascript
    napi.object('news')
        .body({ name: 'myname' })
        .patch('995d6e996b6044e7bc15b4f08eb42999')
        .done(function(data){})
    ```

### .delete(objectID)

* 源码：[lib/object.v3.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/object.v3.js)
* 说明：删除对象
* 参数：
  * objectID ``String``
* 返回：``Promise``
* 示例：

    ```javascript
    napi.object('news')
        .delete('995d6e996b6044e7bc15b4f08eb42999')
        .done(function(data){})
    ```

### .incrs(objectID, field)

* 源码：[lib/object.v3.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/object.v3.js)
* 说明：给对象计数器自增 `1`
* 参数：
  * objectID ``String``
  * field ``String``
* 返回：``Promise``
* 示例：

    ```javascript
    napi.object('news')
        .incrs('995d6e996b6044e7bc15b4f08eb42999', 'yes')
        .done(function(data){})
    ```

### .getIncrs(objectID)

* 源码：[lib/object.v3.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/object.v3.js)
* 说明：获取对象的全部计数器
* 参数：
  * objectID ``String``
* 返回：``Promise``
* 示例：

    ```javascript
    napi.object('news')
        .getIncrs('995d6e996b6044e7bc15b4f08eb42999')
        .done(function(data){})
    ```

------------------------

## comment 接口方法

> SDK 的评论接口使用 v2 版本napi接口，[RESTfull 接口参考文档](http://doc.ucweb.local/pages/viewpage.action?pageId=33456432&src=contextnavchildmode#id-2.NAPI文档v2-评论)

### .list(thread)

* 源码：[lib/comment.v2.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/comment.v2.js)
* 说明：获取 `thread` 下的评论，`thread` 对应 `listID`.[RESTfull 接口文档](http://doc.ucweb.local/pages/viewpage.action?pageId=33456432&src=contextnavchildmode#id-2.NAPI文档v2-获取评论)
* 参数：
  * thread ``String``
* 返回：``Promise``
* 示例：

    ```javascript
    napi.comment('news')
        .list('sub')
        .done(function(data){})
    ```

### .get(commentId)
* 版本：version3
* 源码：[lib/comment.v3.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/comment.v3.js)
* 说明：获取某条评论的数据.[RESTfull 接口文档](http://doc.ucweb.local/pages/viewpage.action?pageId=33456430&src=contextnavpagetreemode#id-1.NAPI文档v3(Alpha)-查询单条评论)
* 参数：
  * thread ``String``
* 返回：``Promise``
* 示例：

    ```javascript
    napi.comment('news')
        .get('xxxx')
        .done(function(data){})
    ```


### .post(thread [, body])

* 源码：[lib/comment.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/comment.v2.js)
* 说明：[发表评论](http://doc.ucweb.local/pages/viewpage.action?pageId=33456432#id-2.NAPI文档v2-发表评论)
* 参数：
  * thread ``String``
  * body ``Object``
* 返回：``Promise``
* 示例：

    ```javascript
    napi.comment('news')
        .post('sub', {
            "author": 'switer',
            "author_id": authorId,
            "message": 'hello world'
        })
        .done(function(data){})
    ```

### .reply(thread, commentID [, body])

* 源码：[lib/comment.v2.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/comment.v2.js)
* 说明：[回复评论](http://doc.ucweb.local/pages/viewpage.action?pageId=33456432#id-2.NAPI文档v2-回复评论)
* 参数：
  * thread ``String``
  * commentID ``String``
  * body ``Object``
* 返回：``Promise``
* 示例：

    ```javascript
    napi.comment('news')
        .reply('sub', '3106909', {
            "author": 'switer',
            "author_id": authorId,
            "message": 'hello world'
        })
        .done(function(data){})
    ```

### .like(thread, commentID)

* 源码：[lib/comment.v2.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/comment.v2.js)
* 说明：[赞评论](http://doc.ucweb.local/pages/viewpage.action?pageId=33456432#id-2.NAPI文档v2-赞评论)
* 参数：
  * thread ``String``
  * commentID ``String``
* 返回：``Promise``
* 示例：

    ```javascript
    napi.comment('news')
        .like('sub', '3106909')
        .done(function (data) {})
    ```

------


## base 接口方法
Base 的接口方法，主要用于拼装自定义NAPI请求，可用于，找不到相关SDK封装的接口后，进行自定义的接口封装。
### .send([options])
* 源码：[lib/base.api.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.api.js)
* 说明：发起一个请求
* 参数：
  * options ``Object`` 请求参数对象。参数包含：
    * url -- 请求的path
    * method -- GET/POST/DELETE/PUT/PATCH；默认为 `GET`
    * headers -- 请求头

* 返回：``Promise``
* 示例：

    ```javascript
    napi.base()
        .send({
          method: 'GET',
          url: '/classes/news/objects/995d6e996b6044e7bc15b4f08eb42999'
        })
        .done(function (data) {})
    ```

### .version(version)
* 源码：[lib/base.api.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.api.js)
* 说明：设置请求NAPI的版本。默认的版本号为 “3”。send请求后不会恢复默认，保持自定义设置。
* 参数：
    * version ``String`` "2" 或 "3"，NAPI接口的版本
* 返回：base 接口实例对象
* 示例：

    ```javascript
    napi.base()
        .version('2')
        .send({
            method: 'GET',
            url: '/classes/news/995d6e996b6044e7bc15b4f08eb42999'
        })
        .done(function (data) {})
    ```

### .host(host)
* 源码：[lib/base.api.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.api.js)
* 说明：设置NAPI的host。默认的版本号为 **http://napi.uc.cn**。send请求后不会恢复默认，保持自定义设置。
* 参数：
    * host ``String`` NAPI接口host，例如：`http://napi.ucweb.com`
* 返回：base 接口实例对象
* 示例：

    ```javascript
    napi.base()
        .host('http://napi.ucweb.com') // 请求国际版接口
        .send({
            url: '/classes/news/995d6e996b6044e7bc15b4f08eb42999'
        })
        .done(function (data) {})
    ```


------

## 接口响应格式

数据接口响应结果使用统一的
### 成功
```javascript
{
    "data":  Object || Array,
    "metadata": Object
}
```
字段说明：
* data 接口成功返回数据，当请求获取的是列表数据，返回的类型为`Array`，否则为`Object`
* metadata 请求带有 `fetchTotal` 之类选项时，返回`metadata`数据

### 失败
```javascript
{
    "error":  {
        "code": Number, 
        "message": String,
        "type": String 
    }
}
```

字段说明：
* code `HTTP`状态码，或`NAPI`返回的错误码
* message 错误描述信息
*  type  **api/parser/http, 标记属于哪个步骤的出错**
    * api NAPI响应的错误
    * parser JSON.parse 时出错
    * http `HTTP`请求错误, 4xx/5xx 


--------------

## 实例对象选项方法

所有选项方法必须在`接口请求方法`后调用

```javascript
napi.object('news').get().fetch() // x 错误

napi.object('news').fetch().get() // √ 正确
```

### .params(params)

* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：请求的GET参数，返回this，支持链式调用。**多次调用会进行参数对象的合并**。 **每次请求发起之后会重置**
* 参数：
  * params ``Object`` 请求的GET参数，是一个 key-value 对象
* 返回：`接口实例` 对象
* 示例：
  
    ```javascript
    napi.params({
            _fetch: 0
        })
        .list('995d6e996b6044e7bc15b4f08eb42999')
        .done(function(data) {})
    ```

### .body(body)

* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：设置 POST/PUT/PATCH/DELETE 请求的发送数据，返回this，支持链式调用。**多次调用，后面的会覆盖前面**。 **每次请求发起之后会重置**
* 参数：
  * body ``Object`` 请求的POST参数，是一个kv对象
* 返回：`接口实例` 对象
* 示例：
  
    ```javascript
    napi.comment('news')
        .body({
            "author": 'switer',
            "author_id": authorId,
            "message": 'hello world'
        })
        .post(thread)
        .done(function (data) {})
    ```

### .sign(appKey)

* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：请求私有接口时加签名，详情请参考这里： [NAPI安全体系使用说明](http://doc.ucweb.local/pages/viewpage.action?pageId=38013436)
* 参数：
  * appKey ``String`` 请求的POST参数，是一个kv对象
* 返回：`接口实例` 对象
* 示例：
  
    ```javascript
    napi.sign('97287303713f49acbba3fbf6aa237241')
        .get('f875057e60a14fbaa8306cbe56f7fb23')
        .done(function(data) {})
    ```

### .etag(bool)
* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：是否启用用数据接口 `Etag` 缓存
* 参数：
  * bool ``Boolean`` 参数为空时，默认为 true
* 返回：`接口实例` 对象

### .fetch(bool)
* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：是否返回对象全部字段
* 参数：
  * bool ``Boolean`` 参数为空时，默认为 true
* 返回：`接口实例` 对象

### .fetchIncrs(bool)
* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：是否返回对象关联的计数器
* 参数：
  * bool ``Boolean`` 参数为空时，默认为 true
* 返回：`接口实例` 对象

### .fetchVersion(bool)
* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：是否返回对象的协同编辑版本。**如果选择返回，将会在对象里包含一个键为 `_version`**
* 参数：
  * bool ``Boolean`` 参数为空时，默认为 true
* 返回：`接口实例` 对象

### .fetchTotal(bool)
* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：是否返回总数。**fetchTotal 只能用户获取列表数据（包括评论列表）时生效，获取Class下的全部数据时不生效**
* 参数：
  * bool ``Boolean`` 参数为空时，默认为 true
* 返回：`接口实例` 对象

### .select(key [, key2, ..., keyN])
* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：指定只需要返回的字段。**多个字段用英文逗号(,)分割。**
* 参数：
  * key ``String``
* 返回：`接口实例` 对象

### .deselect(key [, key2, ..., keyN])
* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：指定不返回的字段。**多个字段用英文逗号(,)分割。**
* 参数：
  * key ``String``
* 返回：`接口实例` 对象

### .maxAge(age)

* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：设置请求API的 缓存时间
* 参数：
  * age ``Number`` 缓存时间，单位为秒。默认为 0
* 返回：`接口实例` 对象

### .size(size)
* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：最大返回的结果数量。与获取列表数据结合使用。
* 参数：
  * size ``Number`` 默认为 10，最大 200。
* 返回：`接口实例` 对象

### .page(page)
* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：分页接口，查询第几页的数据。
* 参数：
  * page ``Number`` 默认为 1
* 返回：`接口实例` 对象

### .sincePos(pos)
* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：查询比 pos 值前的数据。
* 参数：
  * pos ``Number``
* 返回：`接口实例` 对象

### .maxPos(pos)
* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：查询比 pos 值后的数据。
* 参数：
  * pos ``Number``
* 返回：`接口实例` 对象

### .query(queries)
* 源码：[lib/base.js](http://git.ucweb.local/navi/napi-node-sdk/blob/master/lib/base.js)
* 说明：设置查询参数，QueryString
* 参数：
  * queries ``Object`` 如：.query({_fetch: 1, _token: xxx})
* 返回：`接口实例` 对象